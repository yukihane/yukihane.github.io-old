<!DOCTYPE html>
<html lang="en"><head>
    





<title>So many UserDetailsService samples considered harmful for beginners | 発火後忘失</title>

<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content='やっぱり一発目の Spring Security やってみたで UserDetailsService 使うのは止めようず。So many UserDetailsService samples considered harmful for beginners. はじめに ちょっと待って！その UserDetails、本当に必要ですか'>
<meta name="keywords" content='spring-boot, spring-security'>
<meta name="msapplication-TileColor" content="#b91d47">
<meta name="theme-color" content="#ffffff">

<link rel="canonical" href="https://yukihane.github.io/posts/202006/13/userdetailsservice-samples-considered-harmful-for-biginners/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#007aa6">
<meta name="theme-color" content="#ffffff">

<meta property="og:title" content="So many UserDetailsService samples considered harmful for beginners" />
<meta property="og:description" content="やっぱり一発目の Spring Security やってみたで UserDetailsService 使うのは止めようず。So many UserDetailsService samples considered harmful for beginners. はじめに ちょっと待って！その UserDetails、本当に必要ですか" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yukihane.github.io/posts/202006/13/userdetailsservice-samples-considered-harmful-for-biginners/" />
<meta property="article:published_time" content="2020-06-13T21:07:40+00:00" />
<meta property="article:modified_time" content="2020-06-13T21:07:40+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="So many UserDetailsService samples considered harmful for beginners"/>
<meta name="twitter:description" content="やっぱり一発目の Spring Security やってみたで UserDetailsService 使うのは止めようず。So many UserDetailsService samples considered harmful for beginners. はじめに ちょっと待って！その UserDetails、本当に必要ですか"/>

<meta itemprop="name" content="">
<meta itemprop="description" content="">
    
    
    
    
    
    <link rel="stylesheet" href='https://yukihane.github.io/css/style.css'>

    


<link href="https://fonts.googleapis.com/css?family=Hanuman:400,700|Inconsolata|Roboto:400,400i,700,700i&display=swap&subset=khmer" rel="stylesheet">
</head><body><header id="navigation" class="p-navigation">
    <div class="p-navigation__row">
        <div class="p-navigation__banner">
            <div class="p-navigation__logo">
                <a class="p-navigation__link u-vertically-center p-link--logo" href="https://yukihane.github.io/">
                    発火後忘失
                </a>
            </div>
            
            <a href="#navigation" class="p-navigation__toggle--open" title="menu">
                <i class="p-icon--menu"></i>
            </a>
            <a href="#navigation-closed" class="p-navigation__toggle--close" title="close menu">
                <i class="p-icon--close"></i>
            </a>
        </div>

        <nav class="p-navigation__nav">
            <span class="u-off-screen">
                <a href="#main-content">Jump to main content</a>
            </span>

            <ul class="p-navigation__links" role="menu">
                
            </ul>

            
            <form class="p-search-box" action="https://www.google.com/search" target="_blank">
    <input type="search" class="p-search-box__input" name="q" placeholder='Search'
        required="" aria-label="Query">
    <input type="hidden" name="sitesearch" value="https://yukihane.github.io/">
    <button type="reset" class="p-search-box__reset" alt="reset" aria-label="Reset">
        <i class="p-icon--close"></i>
    </button>
    <button type="submit" class="p-search-box__button" alt="search" aria-label="Search">
        <i class="p-icon--search"></i>
    </button>
</form>
            
        </nav>
    </div>
</header><div id="main-content">
<header class="p-strip page-banner">
    <div class="row">
        <h1>So many UserDetailsService samples considered harmful for beginners</h1>
    </div>

    

<div class="row">

    
    <div class="col-8">
        




<div class="p-media-object">

    

    <div class="p-media-object__details">

        

        
        <p class="p-media-object__content">
            <span class="u-capitalized">on</span>
            2020-06-13
        </p>
        

    </div>
</div>


    </div>
    

    
    <div class="col-4  col--share-links ">
        <ul class="p-inline-list-icons p-inline-list-icons--share-links u-no-padding--left u-no-margin--left u-unselectable">
    <li class="p-inline-list__item">
        <i class="p-icon--share"></i>
    </li>
    <li class="p-inline-list__item">
        <a class="p-icon--facebook" title='Share on Facebook' target="_blank"
            rel="noreferrer" href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fyukihane.github.io%2fposts%2f202006%2f13%2fuserdetailsservice-samples-considered-harmful-for-biginners%2f">
            Facebook
        </a>
    </li>
    <li class="p-inline-list__item">
        <a class="p-icon--twitter" title='Share on Twitter' target="_blank"
            rel="noreferrer" href="http://twitter.com/share?text=So%20many%20UserDetailsService%20samples%20considered%20harmful%20for%20beginners&amp;url=https%3a%2f%2fyukihane.github.io%2fposts%2f202006%2f13%2fuserdetailsservice-samples-considered-harmful-for-biginners%2f">
            Twitter
        </a>
    </li>
    <li class="p-inline-list__item">
        <a class="p-icon--linkedin" title='Share on LinkedIn' target="_blank"
            rel="noreferrer"
            href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fyukihane.github.io%2fposts%2f202006%2f13%2fuserdetailsservice-samples-considered-harmful-for-biginners%2f&amp;title=So%20many%20UserDetailsService%20samples%20considered%20harmful%20for%20beginners">
            LinkedIn
        </a>
    </li>
</ul>
    </div>
    

</div>




<div class="row">
    <div class="col-12">
        
<a href="https://yukihane.github.io/tags/spring-boot/">#spring-boot</a>&ensp;

<a href="https://yukihane.github.io/tags/spring-security/">#spring-security</a>&ensp;

    </div>
</div>

</header>

<section class="p-strip is-shallow">
    <main class="row post-content">
        <p>やっぱり一発目の Spring Security やってみたで UserDetailsService 使うのは止めようず。So many UserDetailsService samples considered harmful for beginners.</p>
<h1 id="はじめに">はじめに</h1>
<p><a href="https://qiita.com/yukihane/items/865db9e7279cf0e588a7">ちょっと待って！その UserDetails、本当に必要ですか？</a>で書いたことの繰り返しなんですけども。</p>
<p>Spring Security で認証機能やってみた系のエントリは高確率で<a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/api/org/springframework/security/core/userdetails/UserDetailsService.html"><code>UserDetailsService</code></a>, <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/api/org/springframework/security/core/userdetails/UserDetails.html"><code>UserDetails</code></a>使って実装してると思うんだけど、そんなん使って実装してみても重要なところなんも理解できなかったでしょ？
(暗黙のデフォルト設定がゴイゴイ入っているので、そのデフォルト設定の仕組みを理解しないことには肝心の認証機能について入っていけないでしょ？)</p>
<p>自分は<a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/reference/html5/#servlet-authentication">10. Authentication</a>章の冒頭で列挙されているような要素を理解することがまず優先すべきことだと思ってる。もうちょっと絞て具体的に言うと</p>
<ul>
<li><code>AuthenticationProvider</code>(及びそれを取りまとめる <code>AuthenticationManager</code>): 具体的に認証処理を実装するところ</li>
<li><code>Filter</code>: リクエストをフックして認証処理を行うようにする</li>
<li><code>WebSecurityConfig</code>: 上記のフィルタやら認証プロバイダやらを使うようにする設定</li>
</ul>
<p>の 3 点を理解するのが最初の一歩目だと信じてるんですねこれ。</p>
<p>ところが(すっとこ)どっこい(しょ)、<code>UserDetailsService</code>使うと実際に認証処理を行うところである<code>AuthenticationProvider</code>からしてどこにいっちゃってるのかわかんなくなる。
いやいやさすがにそこ外したらいかんでしょ、というのが私が懸念するところです。</p>
<p>なのでここで<code>UserDetailsService</code>を使わない「やってみた」記事をぶちかまそうというのが主旨です。</p>
<p>ちなみに、タイトルでは「一発目に使うのは止めよう」と言っていますが、個人的には二発目以降も別に要らんと思ってます。
ただ<a href="https://docs.spring.io/spring-security/site/docs/5.1.5.RELEASE/reference/htmlsingle/#tech-userdetailsservice">公式ドキュメントでえらい推されてる</a>んで若干弱気(…と思って最新版のドキュメント見たらこの辺の記述無くなって、やや推し力は弱まっている感じも受けたけど(それでもまだドキュメント内を&quot;userdetails&quot;で検索すると 248 箇所もヒットするんだけどね))。
<code>UserDetailsService</code>使えばこんな便利なんだぜ！みたいなことがあるのなら教えて欲しいんだぜ。</p>
<p>更にちなむと、公式ドキュメント中で最も簡潔に<code>UserDetailsService</code>について説明されているのは&rdquo;<a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/reference/html5/#appendix-faq-what-is-userdetailservice">What is a UserDetailsService and do I need one?</a>&ldquo;節。そんな長くないので全文引っ張ってくると:</p>
<blockquote>
<p><code>UserDetailsService</code> is a DAO interface for loading data that is specific to a user account. It has no other function other to load that data for use by other components within the framework. It is not responsible for authenticating the user. Authenticating a user with a username/password combination is most commonly performed by the <code>DaoAuthenticationProvider</code>, which is injected with a <code>UserDetailsService</code> to allow it to load the password (and other data) for a user in order to compare it with the submitted value. Note that if you are using LDAP, this approach may not work.</p>
</blockquote>
<blockquote>
<p>If you want to customize the authentication process then you should implement <code>AuthenticationProvider</code> yourself. See this blog article for an example integrating Spring Security authentication with Google App Engine.</p>
</blockquote>
<p>というわけで、前述の<code>UserDetailsService</code>に隠されてしまった<code>AuthenticationProvider</code>実装というのは<code>DaoAuthenticationProvider</code>のことなんですけれども、<code>UserDetailsService</code>使って「やってみた」人、その点理解できてました？</p>
<p>そして本記事の主旨としては、このドキュメントの文章を借りれば、&ldquo;implement AuthenticationProvider yourself&quot;をちゃんと「やってみた」しとこうよ、ということになるんだわさ。</p>
<h1 id="コードへのリンク">コードへのリンク</h1>
<p><a href="https://github.com/yukihane/hello-java/tree/master/spring/springboot-auth-example-202006">https://github.com/yukihane/hello-java/tree/master/spring/springboot-auth-example-202006</a></p>
<p>以降の文章中では、そのタイミングでの実装コードのハッシュも記しています。</p>
<h1 id="やってみたしてみよう">「やってみた」してみよう！</h1>
<h2 id="ところでそもそも何を作ろうとしているの">ところで、そもそも何を作ろうとしているの？</h2>
<p>以下のの blog で実装している機能(の途中まで)をパクらせてもらいます。</p>
<ul>
<li><a href="https://auth0.com/blog/implementing-jwt-authentication-on-spring-boot/">Implementing JWT Authentication on Spring Boot APIs - Aauth0 Blog</a></li>
</ul>
<p>(以降、こちらの blog エントリのことを「参考元」と呼称します。)</p>
<p>次のような機能を提供する Web API を実装します:</p>
<ul>
<li>ユーザ登録</li>
<li>登録したユーザの認証(ログイン)</li>
<li>ログインしたユーザのみが取得できるリソース提供</li>
</ul>
<p>あんま参考元タイトルに&quot;JWT&quot;という単語が入ってますがそこはあんま関係ないです。<code>AuthenticationProvider</code>自作するためのネタになっているだけです。</p>
<p>あと、参考元あるんやったらそっち見た方が良いんじゃないの？という疑問については:</p>
<ul>
<li>参考元は <code>UserDetailsService</code> 使っているのに対しこちらは使っていない、というのが最も大きな違いです</li>
<li>参考元は一気にコードがドバっと出てくるので、実際に作る順番がわかりづらいかな、と思いました(のでこちらでは順番考えて説明しています)</li>
<li>あとは、勘違いしそうな型の使い回しをなるべくやめたり、誤解しそうな箇所だと思う点について細かな修正を行っています</li>
</ul>
<h2 id="ベースプロジェクトの作成と基本設定追加">ベースプロジェクトの作成と基本設定追加</h2>
<p>それじゃ早速やっていきましょう。</p>
<h3 id="ベースプロジェクト作成">ベースプロジェクト作成</h3>
<p><a href="https://start.spring.io/">https://start.spring.io/</a> でベースを作成しよう。ちなみに Jav11 の想定で、今回利用する SpringBoot のバージョンはリリースされたてほやほやの 2.3.1 だ！(このサンプル書いてる途中にリリースされたよ！)</p>
<p>利用する dependencies は次の通り:</p>
<ul>
<li>使う使わないに関わらず取り敢えずぶち込んどけ系: <strong>DevTools</strong>, <strong>Lombok</strong>, <strong>Spring Configuration Processor</strong></li>
<li>スタンダードなウェブアプリ作るので: <strong>Spring Web</strong></li>
<li>Spring Security をやってみたするので当然: <strong>Spring Security</strong></li>
<li>DB にユーザ登録してそのデータで認証処理するので: <strong>Spring Data JPA</strong>, <strong>H2 Database</strong></li>
</ul>
<p>ベースプロジェクトの作成が終わったら、ダウンロード&amp;展開して<a href="https://spring.io/tools">Spring Tools 4 for Eclipse</a>を起動してプロジェクトをインポートしよう。</p>
<p>続いて色々基本的な設定を加えていくよ。</p>
<h3 id="依存ライブラリの追加">依存ライブラリの追加</h3>
<p>参考元に書いてある通り、今回のサンプルでは次のライブラリが追加で必要なので<code>pom.xml</code>の<code>dependencies</code>に追加します:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml:pom.xml" data-lang="xml:pom.xml">    <span style="color:#f92672">&lt;dependency</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;groupId</span><span style="color:#f92672">&gt;</span>javax.xml.bind<span style="color:#f92672">&lt;/groupId&gt;</span>
      <span style="color:#f92672">&lt;artifactId</span><span style="color:#f92672">&gt;</span>jaxb-api<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#f92672">&lt;dependency</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;groupId</span><span style="color:#f92672">&gt;</span>com.auth0<span style="color:#f92672">&lt;/groupId&gt;</span>
      <span style="color:#f92672">&lt;artifactId</span><span style="color:#f92672">&gt;</span>java-jwt<span style="color:#f92672">&lt;/artifactId&gt;</span>
      <span style="color:#f92672">&lt;version</span><span style="color:#f92672">&gt;</span>3.10.3<span style="color:#f92672">&lt;/version&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
</code></pre></div><h3 id="sql-ログ出力">SQL ログ出力</h3>
<p>インメモリ DB 使うのでホンマに DB に入ってんの？とか気になると思うので SQL をログ出力するようにしときます。</p>
<pre><code class="language-properties:src/main/resources/application.properties" data-lang="properties:src/main/resources/application.properties">logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
</code></pre><h3 id="userdetailsservice-の-auto-configuration-を無効化">UserDetailsService の auto-configuration を無効化</h3>
<p>今回の目玉、<code>UserDetailsService</code>を使わない、を確実にするために<code>UserDetailsServiceAutoConfiguration</code>を disable します。デフォルトだと良い感じに設定されちゃってるので、使ってないつもりで使ってた、みたいなことが(SpringBoot あるある)。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/SpringbootAuthExample202006Application.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/SpringbootAuthExample202006Application.java"><span style="color:#f92672">package</span> com.example.springbootauthexample202006<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@SpringBootApplication</span><span style="color:#f92672">(</span>exclude <span style="color:#f92672">=</span> UserDetailsServiceAutoConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpringbootAuthExample202006Application</span> <span style="color:#f92672">{</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div><h3 id="websecurityconfg-の-auto-configuration-を無効化">websecurityconfg の auto-configuration を無効化</h3>
<p><a href="https://qiita.com/yukihane/items/cdb7f348da9b32b2ff4d">この件</a>です。未設定の状態だと Boot 君がよしなに設定してくれちゃうんで取り敢えず次の設定をぶち込んでおきます:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/security/MyWebSecurityConfig.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/security/MyWebSecurityConfig.java"><span style="color:#f92672">package</span> com.example.springbootauthexample202006.security<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.springframework.context.annotation.Configuration<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyWebSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        http<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">disable</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">sessionManagement</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sessionCreationPolicy</span><span style="color:#f92672">(</span>SessionCreationPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">STATELESS</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>いや空設定ちゃうんかい！<code>csrf</code>とか何やねんそれ！というツッコミについては、今回のスコープから外れるのでパス。
画面じゃない Web API なんでこれで良いんですぅ。</p>
<p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/31312e8c94530bb6f6272d0b9c6c9607a83939ec/spring/springboot-auth-example-202006">31312e8c94530bb6f6272d0b9c6c9607a83939ec</a></p>
<h2 id="ユーザエンティティの作成">ユーザエンティティの作成</h2>
<p>さてベースを設定し終わったので実装に入りましょう。</p>
<p>何から作るのが自然かと聞かれたときユーザのエンティティから作ると答えるのは別に変じゃなかろうもん。
ログイン ID とかパスワードを保持するところ、最初に欲しいよね？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.example.springbootauthexample202006.user<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> javax.persistence.Column<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.persistence.Entity<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.persistence.GeneratedValue<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.persistence.Id<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.persistence.Version<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> lombok.Data<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> lombok.NoArgsConstructor<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@Entity</span>
<span style="color:#a6e22e">@Data</span>
<span style="color:#a6e22e">@NoArgsConstructor</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationUser</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Id</span>
    <span style="color:#a6e22e">@GeneratedValue</span>
    <span style="color:#66d9ef">private</span> Long id<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Version</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> version<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Column</span><span style="color:#f92672">(</span>nullable <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> unique <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">private</span> String username<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Column</span><span style="color:#f92672">(</span>nullable <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">private</span> String password<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ApplicationUser</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String username<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> username<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">password</span> <span style="color:#f92672">=</span> password<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>はい。特筆すべきところが無い普通の JPA Entity クラスです。もうちょっとそれっぽく email とかの項目有っても良いんじゃないかとも一瞬考えましたが面倒なのでやめました。</p>
<p>ところでいきなり余談に入るんだけれど(なので読み飛ばして OK)、<code>UserDetailsService</code>を使う場合、<code>UserDetails</code>は上記のようなユーザエンティティに実装すべきでしょうか？</p>
<p>自分は、</p>
<ul>
<li>一般的には<strong>ユーザエンティティは<code>UserDetails</code>を実装する必要はない</strong>(し、実装しちゃうと理解の妨げになるので、少なくともやってみたコードでは実装すべきではない)
<ul>
<li>(<code>UserDetails</code>って <a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/api/org/springframework/security/core/Authentication.html#getPrincipal--"><code>Authentication#getPrincipal()</code></a> で取得できるようになる情報っしょ？principal = ユーザ なわけなく<a href="https://www.youtube.com/watch?v=BhWq-ceJa5k">なくなくなくなくなくない</a>？)</li>
</ul>
</li>
</ul>
<p>派なんだけれども、巷にあふれるやってみたコードでは実装しちゃってるコードがどちゃくそ多い。
…書いてて気になってきたのでちょっと Qiita 内の記事で見てみよう…というわけで根気が途切れるまで新着順で検索してみた:</p>
<ul>
<li>ユーザエンティティに<code>UserDetails</code>を implements <strong>する</strong> 派
<ul>
<li><a href="https://qiita.com/zakioka_pirori/items/f07a768353ac789528dd">SpringSecurity(securityConfig)によるログイン機能実装</a></li>
<li><a href="https://qiita.com/teradatk/items/1e09f0ed4a29d2699504">spring boot security + DB 認証を試した時のポイント</a></li>
<li><a href="https://qiita.com/renoinn/items/a957431018aa033768ce">SpringBoot(Kotlin)と Freemarker でログインするサンプル作った</a></li>
<li><a href="https://qiita.com/t-iguchi/items/9d12ab0b260e286ba18c">SpringBoot + Spring Security で認証を行う</a></li>
</ul>
</li>
<li>ユーザエンティティに<code>UserDetails</code>を implements <strong>しない</strong> 派
<ul>
<li><a href="https://qiita.com/t_skri/items/10760c93b1788207215f">Visual Studio Code による Spring5 MVC Web アプリ開発　 Spring Security 使用編 1/3【準備編】</a></li>
<li><a href="https://qiita.com/velphedia/items/5700e701a6350d4dc782">Spring-Security の新規登録とログイン（JPA）</a></li>
<li><a href="https://qiita.com/1412azkz/items/62a14fd5beae96b326a0">Spring Security で DB 認証&amp;BCrypt でハッシュ化</a></li>
<li><a href="https://qiita.com/rubytomato@github/items/8eee9e3fa86c89dd305c">Spring Security と Spring Boot で最小機能のデモアプリケーションを作成する</a></li>
<li><a href="https://qiita.com/YJ2222/items/3047949cb6018d2453dc">SpringSecurity で認証機能を実装 ③</a></li>
</ul>
</li>
<li>その他: <code>UserDetails</code>にユーザエンティティを所有させる派
<ul>
<li><a href="https://qiita.com/Tomohiro1993/items/c41931ef63cc36c48543">Spring Security データベースの認証</a></li>
<li><a href="https://qiita.com/huge-book-storage/items/69485cd8a7b3bc589d4a">Spring Security ログイン認証の DB アクセス処理を実装</a></li>
<li><a href="https://qiita.com/yamateion/items/c1affc4fa8defa814a41">Spring boot で、パスワードをハッシュ化して会員登録 &amp; Spring security を使って、ログイン機能実装。</a></li>
<li><a href="https://qiita.com/shibafu/items/18609b4100994a62dc71">SpringSecurity で認証作ってみた　その１フォーム認証</a></li>
<li><a href="https://qiita.com/TomohiroSaito/items/dee4f22a3cf94edff7df">Spring Security データベースの認証</a></li>
<li><a href="https://qiita.com/rubytomato@github/items/6c6318c948398fa62275">Spring Security with Spring Boot 2.0 で簡単な Rest API を実装する</a></li>
<li><a href="https://qiita.com/Hyuga-Tsukui/items/8c7e3d9201d07d2be089">SpringSecurity で DB ログイン認証処理を実装してみた(MyBatis 使用)</a></li>
</ul>
</li>
</ul>
<p>(あんま時間かけて見てないので分類間違い御免)</p>
<p>…どちゃくそ多いという程ではなかった。でも第 3 の派閥を見つけてしまったよ…</p>
<p>ちなみに<a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/reference/html5/">公式リファレンス</a>では<code>UserDetails</code>についての指針は特に無いし、公式ガイド(<a href="https://spring.io/guides/gs/securing-web/">1</a>,<a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/">2</a>)のサンプルコード含めてもインメモリで<code>UserDetails</code>オブジェクト作ってる例ばっかりでそれを実際にはどこからどうやって取得すべきなのかが推測できないものばっかり。うーんこ 💩 の。</p>
<h2 id="サインアップ機能ユーザ登録機能">サインアップ機能(ユーザ登録機能)</h2>
<p>さあさ続きましてはさっきの<code>ApplicationUser</code>の永続化でございます。
まだ Spring Security 関係ないのでサクッと行きましょう。</p>
<p>コントローラと、コントローラがつこてる<code>ApplicationUser</code>リポジトリを実装。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/user/UserController.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/user/UserController.java"><span style="color:#f92672">package</span> com.example.springbootauthexample202006.user<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.util.List<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> lombok.Data<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> lombok.RequiredArgsConstructor<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> lombok.extern.slf4j.Slf4j<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.web.bind.annotation.PostMapping<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestBody<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestMapping<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@RestController</span>
<span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/users&#34;</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">@RequiredArgsConstructor</span>
<span style="color:#a6e22e">@Slf4j</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Data</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserForm</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">private</span> String username<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">private</span> String password<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ApplicationUserRepository applicationUserRepository<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@PostMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/sign-up&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">signUp</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@RequestBody</span> <span style="color:#66d9ef">final</span> UserForm form<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> ApplicationUser user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ApplicationUser<span style="color:#f92672">(</span>
            form<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span>
            form<span style="color:#f92672">.</span><span style="color:#a6e22e">getPassword</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> ApplicationUser saved <span style="color:#f92672">=</span> applicationUserRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>user<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;User sign-upped: {}&#34;</span><span style="color:#f92672">,</span> saved<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>ApplicationUser<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">users</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> applicationUserRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">findAll</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/user/ApplicationUserRepository.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/user/ApplicationUserRepository.java"><span style="color:#f92672">package</span> com.example.springbootauthexample202006.user<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.springframework.data.jpa.repository.JpaRepository<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.stereotype.Repository<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@Repository</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ApplicationUserRepository</span> <span style="color:#66d9ef">extends</span> JpaRepository<span style="color:#f92672">&lt;</span>ApplicationUser<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/916d7bed6d26787b73091725a662a39051130f04/spring/springboot-auth-example-202006">916d7bed6d26787b73091725a662a39051130f04</a></p>
<p>ここまで実装できたら実際に動かしてみよう。<code>curl</code>を使って次を実行だ:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -X POST -d <span style="color:#e6db74">&#39;{
</span><span style="color:#e6db74">    &#34;username&#34;: &#34;yamada&#34;,
</span><span style="color:#e6db74">    &#34;password&#34;: &#34;password&#34;
</span><span style="color:#e6db74">}&#39;</span> http://localhost:8080/users/sign-up
</code></pre></div><p>これで<code>yamada</code>君が登録された。ログにそれっぽい出力があるはずだ。あるいは、</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl http://localhost:8080/users
</code></pre></div><p>で登録ユーザ一覧が見られる。</p>
<h3 id="パスワードのハッシュ化">パスワードのハッシュ化</h3>
<p>(今回の流れで出すには少し細かい話なのかなと思ったのだけれど、)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl http://localhost:8080/users
</code></pre></div><p>を見て気づいたであろうか。そう！！誰も！！パスワードをハッシュ化していないのである！！</p>
<p>というわけでハッシュ化しましょう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/user/UserController.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/user/UserController.java">    <span style="color:#a6e22e">@PostMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/sign-up&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">signUp</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@RequestBody</span> <span style="color:#66d9ef">final</span> UserForm form<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">final</span> PasswordEncoder passwordEncoder <span style="color:#f92672">=</span> PasswordEncoderFactories<span style="color:#f92672">.</span><span style="color:#a6e22e">createDelegatingPasswordEncoder</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> ApplicationUser user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ApplicationUser<span style="color:#f92672">(</span>
            form<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span>
            passwordEncoder<span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span>form<span style="color:#f92672">.</span><span style="color:#a6e22e">getPassword</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> ApplicationUser saved <span style="color:#f92672">=</span> applicationUserRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>user<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;User sign-upped: {}&#34;</span><span style="color:#f92672">,</span> saved<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/ec6b8045d0b007c1c6dd3eb58b31bd8b117ee362/spring/springboot-auth-example-202006">ec6b8045d0b007c1c6dd3eb58b31bd8b117ee362</a></p>
<p>もう一度上に書いた<code>curl</code>コマンドを実行してみよう。今度は生パスワードでなくハッシュ化されたパスワードが DB に保存されたはずだ。</p>
<p>ちなみにこの<code>PasswordEncoder</code>、巷のやってみた記事では次のように Bean 化しているものが多い。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyConfig</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Bean</span>
    <span style="color:#66d9ef">public</span> PasswordEncoder <span style="color:#a6e22e">passwordEncoder</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div><p>だけどなァ、これをするとなァ、<a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/reference/html5/#authentication-password-storage-configuration">Spring Security のグローバルのデフォルト設定が置き換わ</a>っちまうんだよなァ。</p>
<p>わかっててやってるなら良いんだけど、何の説明もなしにいきなり書くなら参考元のように<code>BCryptPasswordEncoder</code>を Bean 化するのが無難じゃなかろかいな。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Bean</span>
    <span style="color:#66d9ef">public</span> BCryptPasswordEncoder <span style="color:#a6e22e">bCryptPasswordEncoder</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> BCryptPasswordEncoder<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h2 id="セキュリティ設定">セキュリティ設定</h2>
<p>ﾋｬﾊｯｰ!ついに Spring Security の時間だぜ！</p>
<p>取り敢えず原則認証受けてないとアクセスできないように設定しよう。
ただし、上で実装したサインアップエンドポイントだけは例外だ。誰でもアクセスできなくちゃあならない。
(さもなくば、服を買いに行くための服が無い状態だ。)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/security/MyWebSecurityConfig.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/security/MyWebSecurityConfig.java">http<span style="color:#f92672">.</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">antMatchers</span><span style="color:#f92672">(</span>HttpMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">POST</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/users/sign-up&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">permitAll</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">anyRequest</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>ここもまあハマりポイントとかいろいろ有ったりすると思うんだけど涙をのんで今回は詳しい話をパス！</p>
<p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/2692a5c1fc141d412777d3e9126c6f4f99727d87/spring/springboot-auth-example-202006">2692a5c1fc141d412777d3e9126c6f4f99727d87</a></p>
<p>さて上記セキュリティ設定が済んだらもう一度上の<code>curl</code>コマンドを実行してみよう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -X POST -d <span style="color:#e6db74">&#39;{
</span><span style="color:#e6db74">    &#34;username&#34;: &#34;tanaka&#34;,
</span><span style="color:#e6db74">    &#34;password&#34;: &#34;password&#34;
</span><span style="color:#e6db74">}&#39;</span> http://localhost:8080/users/sign-up
</code></pre></div><p>ふむ、ユーザ登録は登録できているように見える。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl http://localhost:8080/users
</code></pre></div><p>ん？<code>403</code>に変わったぞ？となったら正解だ。自由にアクセスできないようにセキュリティ設定したんだからな！</p>
<h2 id="認証の実現">認証の実現</h2>
<h3 id="認証フィルタ">認証フィルタ</h3>
<p>さあそろそろヤマ場だ。
認証フィルタは冒頭「はじめに」で書いた通りリクエストをフックして認証処理を行わせるところだ。</p>
<p>今回、敢えて自作するサンプルを選んだわけだけれども、そういう場合でも 1 から作るみたいなことはあんまりないと思う。
一番よくあるのは今回みたいに <code>UsernamePasswordAuthenticationFilter</code> を継承してカスタマイズする、みたいなものなんじゃなかろうか。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-src/main/java/com/example/springbootauthexample202006/security/JWTAuthenticationFilter.java" data-lang="src/main/java/com/example/springbootauthexample202006/security/JWTAuthenticationFilter.java"><span style="color:#f92672">package</span> com.example.springbootauthexample202006.security<span style="color:#f92672">;</span>

<span style="color:#f92672">import static</span> com.auth0.jwt.algorithms.Algorithm.HMAC512<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> com.auth0.jwt.JWT<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> com.fasterxml.jackson.databind.ObjectMapper<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.Date<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.FilterChain<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.ServletException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.http.HttpServletRequest<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.http.HttpServletResponse<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.authentication.AuthenticationManager<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.core.Authentication<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.core.AuthenticationException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JWTAuthenticationFilter</span> <span style="color:#66d9ef">extends</span> UsernamePasswordAuthenticationFilter <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SECRET <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SecretKeyToGenJWTs&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> EXPIRATION_TIME <span style="color:#f92672">=</span> 864_000_000<span style="color:#f92672">;</span> <span style="color:#75715e">// 10 days
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String TOKEN_PREFIX <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Bearer &#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String HEADER_STRING <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Authorization&#34;</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ObjectMapper objectMpper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">JWTAuthenticationFilter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> AuthenticationManager authenticationManager<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        setAuthenticationManager<span style="color:#f92672">(</span>authenticationManager<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">attemptAuthentication</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> HttpServletRequest req<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">final</span> HttpServletResponse res<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AuthenticationException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> LoginForm form <span style="color:#f92672">=</span> objectMpper<span style="color:#f92672">.</span><span style="color:#a6e22e">readValue</span><span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span> LoginForm<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">final</span> UsernamePasswordAuthenticationToken creds <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken<span style="color:#f92672">(</span>
                form<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsername</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span>
                form<span style="color:#f92672">.</span><span style="color:#a6e22e">getPassword</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">return</span> getAuthenticationManager<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>creds<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>e<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">successfulAuthentication</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> HttpServletRequest req<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">final</span> HttpServletResponse res<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">final</span> FilterChain chain<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">final</span> Authentication auth<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">final</span> String token <span style="color:#f92672">=</span> JWT<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">withSubject</span><span style="color:#f92672">(</span>auth
                <span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">withExpiresAt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> EXPIRATION_TIME<span style="color:#f92672">)</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">sign</span><span style="color:#f92672">(</span>HMAC512<span style="color:#f92672">(</span>SECRET<span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        res<span style="color:#f92672">.</span><span style="color:#a6e22e">addHeader</span><span style="color:#f92672">(</span>HEADER_STRING<span style="color:#f92672">,</span> TOKEN_PREFIX <span style="color:#f92672">+</span> token<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/2d84598819a0574f188b57c930a06c23ff7c2db7/spring/springboot-auth-example-202006">2d84598819a0574f188b57c930a06c23ff7c2db7</a></p>
<p>長い割に重要なポイントは 2 つだけなんだけど、</p>
<ul>
<li><code>getAuthenticationManager().authenticate(creds);</code> としてるのが認証プロバイダ(※次節で実装)に認証処理を委譲しているところ。フィルタがやってるのはその認証プロバイダが認証を行うのに必要な情報の抽出。</li>
<li>(このコード上には現れていなくて、<a href="https://github.com/spring-projects/spring-security/blob/5.3.3.RELEASE/web/src/main/java/org/springframework/security/web/authentication/UsernamePasswordAuthenticationFilter.java#L63">親クラスがやっている</a>ことなんだけれど、)このフィルタが適用される、つまり認証処理が行われるのは <code>/login</code> に対する <code>POST</code> 。</li>
</ul>
<p>というわけで、次は委譲先、認証プロバイダの実装だ。</p>
<h3 id="認証プロバイダ">認証プロバイダ</h3>
<p>入力されたユーザ名とパスワードが DB データと一致してるか確認する、これが！これこそが！みんなの思い描く認証だ！</p>
<p><code>UserDetailsSevice</code>使ったときのモヤモヤが晴れるだろう！この素直な実装！</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/security/ApplicationUserAuthenticationProvider.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/security/ApplicationUserAuthenticationProvider.java"><span style="color:#f92672">package</span> com.example.springbootauthexample202006.security<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> com.example.springbootauthexample202006.user.ApplicationUser<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> com.example.springbootauthexample202006.user.ApplicationUserRepository<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.Optional<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> lombok.RequiredArgsConstructor<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.authentication.AuthenticationProvider<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.authentication.BadCredentialsException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.core.Authentication<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.core.AuthenticationException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.crypto.password.PasswordEncoder<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@RequiredArgsConstructor</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationUserAuthenticationProvider</span> <span style="color:#66d9ef">implements</span> AuthenticationProvider <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> PasswordEncoder passwordEncoder<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ApplicationUserRepository applicationUserRepository<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Authentication authentication<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> AuthenticationException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> UsernamePasswordAuthenticationToken auth <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>UsernamePasswordAuthenticationToken<span style="color:#f92672">)</span> authentication<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> String username <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span> auth<span style="color:#f92672">.</span><span style="color:#a6e22e">getPrincipal</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> String password <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span> auth<span style="color:#f92672">.</span><span style="color:#a6e22e">getCredentials</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> Optional<span style="color:#f92672">&lt;</span>ApplicationUser<span style="color:#f92672">&gt;</span> user <span style="color:#f92672">=</span> applicationUserRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">findByUsername</span><span style="color:#f92672">(</span>username<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> Optional<span style="color:#f92672">&lt;</span>ApplicationUserAuthentication<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>u <span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>passwordEncoder<span style="color:#f92672">.</span><span style="color:#a6e22e">matches</span><span style="color:#f92672">(</span>password<span style="color:#f92672">,</span> u<span style="color:#f92672">.</span><span style="color:#a6e22e">getPassword</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ApplicationUserAuthentication<span style="color:#f92672">(</span>username<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">orElseThrow</span><span style="color:#f92672">(</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">new</span> BadCredentialsException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;illegal username or password&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Class<span style="color:#f92672">&lt;</span><span style="color:#f92672">?</span><span style="color:#f92672">&gt;</span> authentication<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> UsernamePasswordAuthenticationToken<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/a9478f869c84248cb7dcddff8d192878e0388810/spring/springboot-auth-example-202006">a9478f869c84248cb7dcddff8d192878e0388810</a></p>
<h3 id="認証処理の利用設定">認証処理の利用設定</h3>
<p>さあ、認証の実装は行ったので、後はこの実装を使うように設定変更するだけだ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/security/MyWebSecurityConfig.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/security/MyWebSecurityConfig.java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#a6e22e">@RequiredArgsConstructor</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyWebSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ApplicationUserRepository applicationUserRepository<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

        <span style="color:#66d9ef">final</span> PasswordEncoder passwordEncoder <span style="color:#f92672">=</span> PasswordEncoderFactories<span style="color:#f92672">.</span><span style="color:#a6e22e">createDelegatingPasswordEncoder</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> AuthenticationProvider provider <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ApplicationUserAuthenticationProvider<span style="color:#f92672">(</span>passwordEncoder<span style="color:#f92672">,</span>
            applicationUserRepository<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> AuthenticationManager manager <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProviderManager<span style="color:#f92672">(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span>provider<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        http<span style="color:#f92672">.</span><span style="color:#a6e22e">addFilter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> JWTAuthenticationFilter<span style="color:#f92672">(</span>manager<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/973f5f7a33b84ffbc2f9a069c0a9bd0b9393395c/spring/springboot-auth-example-202006">973f5f7a33b84ffbc2f9a069c0a9bd0b9393395c</a></p>
<p><code>http.addFilter()</code>で使用するフィルタを登録する、ってのがこのコードの本質。
そしてフィルタが利用する認証プロバイダ(を管理する認証マネージャ)をコンストラクタで指定してるってわけ。イージーだね！</p>
<p>当然だけど<code>PasswordEncorder</code>は sign-up でユーザ登録したときのものと同じものを使わないと検証できないよ！</p>
<p>んで本題と関係ないけど Java わかってる感出すために<code>Arrays.asList()</code>じゃなくて Java9 で導入された<code>List.of()</code>つこたろ、ってやったら<a href="https://qiita.com/yukihane/items/d7bde522bdb286a18a21">流れるようにバグ踏んだ</a>(#8689])ので皆もイキるときは気をつけよう。</p>
<p>もいっこあんまり関係ない話をすると、Filter を Bean 化すると<a href="https://qiita.com/yukihane/items/3fd4ae02043fb4d99d3c">ちょっと困ったことになったりもした</a>。</p>
<p>前述の<code>PasswordEncoder</code>もそうだけど、よくわからんけど他人のコードコピペして Bean 化しました！ってやると予期しない範囲まで波及してしまうという、これも Spring Boot あるあるだね！</p>
<p>閑話休題。あとここで言っとくべきことは、フィルタの適用順って重要、ってことなんだけど、今回のサンプルではもう 1 個フィルタ追加するのでそんときに説明します。</p>
<p>さあさあ！ついに認証処理を通るリクエストが投げられるようになりましたよ！サインアップしてログインしてみよう！</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -X POST -d <span style="color:#e6db74">&#39;{
</span><span style="color:#e6db74">    &#34;username&#34;: &#34;suzuki&#34;,
</span><span style="color:#e6db74">    &#34;password&#34;: &#34;password&#34;
</span><span style="color:#e6db74">}&#39;</span> http://localhost:8080/users/sign-up
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -i -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -X POST -d <span style="color:#e6db74">&#39;{
</span><span style="color:#e6db74">    &#34;username&#34;: &#34;suzuki&#34;,
</span><span style="color:#e6db74">    &#34;password&#34;: &#34;password&#34;
</span><span style="color:#e6db74">}&#39;</span> http://localhost:8080/login
</code></pre></div><p>そうするとログイン成功してこんな感じのヘッダが付いて返ってくるはず。<a href="https://ja.wikipedia.org/wiki/Bearer%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3">Bearer トークン</a>てやつだね！
(今回説明した事の本質からは逸れてるのであんまり触れないけど、これは <code>JWTAuthenticationFilter</code>が認証が正常に終了した後に<code>successfulAuthentication</code>で生成してるので気になる人はそこを見てね！)</p>
<pre><code>Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJzdXp1a2kiLCJleHAiOjE1OTI4OTM3MDN9.ul4oibmjgOMZPoyqu6NqMENIRmoQ92Ht8WsDFr9UupsUo_FeJH4pCwzAa8RP3XNPojYxaJjjq6u91HKJuraz1g
</code></pre><p>次はこのトークンを使えば保護されたリソースへアクセスできる、ようにする実装だ。</p>
<h2 id="認可フィルタの実装と適用">認可フィルタの実装と適用</h2>
<h3 id="認可フィルタ">認可フィルタ</h3>
<p>上で登場した Bearer トークンの使い方を先に書いとくと、</p>
<pre><code>curl -H &quot;Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJzdXp1a2kiLCJleHAiOjE1OTI4OTM3MDN9.ul4oibmjgOMZPoyqu6NqMENIRmoQ92Ht8WsDFr9UupsUo_FeJH4pCwzAa8RP3XNPojYxaJjjq6u91HKJuraz1g&quot; \
http://localhost:8080/users
</code></pre><p>みたいにヘッダにつけて保護されたリソースを要求すると、サーバは、「おうおう、あんたなら見せてやれるよ」って言ってくれるわけね。</p>
<p>ただ現時点ではそんな実装してないので上のリクエスト投げても敢え無く<code>403</code>になるわけなのよ。それを何とかするのが 2 つめのフィルタ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.example.springbootauthexample202006.security<span style="color:#f92672">;</span>

<span style="color:#f92672">import static</span> com.example.springbootauthexample202006.security.SecurityConstants.HEADER_STRING<span style="color:#f92672">;</span>
<span style="color:#f92672">import static</span> com.example.springbootauthexample202006.security.SecurityConstants.SECRET<span style="color:#f92672">;</span>
<span style="color:#f92672">import static</span> com.example.springbootauthexample202006.security.SecurityConstants.TOKEN_PREFIX<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> com.auth0.jwt.JWT<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> com.auth0.jwt.algorithms.Algorithm<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.FilterChain<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.ServletException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.http.HttpServletRequest<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> javax.servlet.http.HttpServletResponse<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.security.core.context.SecurityContextHolder<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.web.filter.OncePerRequestFilter<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JWTAuthorizationFilter</span> <span style="color:#66d9ef">extends</span> OncePerRequestFilter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilterInternal</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> HttpServletRequest req<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">final</span> HttpServletResponse res<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">final</span> FilterChain chain<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> String header <span style="color:#f92672">=</span> req<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeader</span><span style="color:#f92672">(</span>HEADER_STRING<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>header <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">|</span><span style="color:#f92672">|</span> <span style="color:#f92672">!</span>header<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>TOKEN_PREFIX<span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            chain<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>req<span style="color:#f92672">,</span> res<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> ApplicationUserAuthentication authentication <span style="color:#f92672">=</span> getAuthentication<span style="color:#f92672">(</span>req<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        SecurityContextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setAuthentication</span><span style="color:#f92672">(</span>authentication<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        chain<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>req<span style="color:#f92672">,</span> res<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> ApplicationUserAuthentication <span style="color:#a6e22e">getAuthentication</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> HttpServletRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> String token <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeader</span><span style="color:#f92672">(</span>HEADER_STRING<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// parse the token.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> String username <span style="color:#f92672">=</span> JWT<span style="color:#f92672">.</span><span style="color:#a6e22e">require</span><span style="color:#f92672">(</span>Algorithm<span style="color:#f92672">.</span><span style="color:#a6e22e">HMAC512</span><span style="color:#f92672">(</span>SECRET<span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">verify</span><span style="color:#f92672">(</span>token<span style="color:#f92672">.</span><span style="color:#a6e22e">replace</span><span style="color:#f92672">(</span>TOKEN_PREFIX<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">getSubject</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>username <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ApplicationUserAuthentication<span style="color:#f92672">(</span>username<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/90c26b3dcf6e3ba52651f1ad00e9c8c52b0fd35a/spring/springboot-auth-example-202006">90c26b3dcf6e3ba52651f1ad00e9c8c52b0fd35a</a></p>
<p>ヘッダに設定されている Bearer トークンをデコードして、その結果から得られる情報をもとに <code>Authentication</code>を生成し<code>SecurityContextHolder.getContext().setAuthentication()</code>でセキュリティコンテキストへセットする、というのが日本語での簡単な説明。</p>
<p>ここでセットされた<code>Authentiction</code>の<a href="https://github.com/spring-projects/spring-security/blob/5.3.3.RELEASE/core/src/main/java/org/springframework/security/core/Authentication.java#L103-L122"><code>isAuthenticated()</code>が<code>true</code></a>なので、SpringBoot 君は保護されたリソースへのアクセスを許してくれる。</p>
<h3 id="認可フィルタの利用設定">認可フィルタの利用設定</h3>
<p>フィルタの登録。基本は 1 つめのフィルタと同じだね。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java:src/main/java/com/example/springbootauthexample202006/security/MyWebSecurityConfig.java" data-lang="java:src/main/java/com/example/springbootauthexample202006/security/MyWebSecurityConfig.java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#a6e22e">@RequiredArgsConstructor</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyWebSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
        http<span style="color:#f92672">.</span><span style="color:#a6e22e">addFilterAfter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> JWTAuthorizationFilter<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span> JWTAuthenticationFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ここまでのコード: <a href="https://github.com/yukihane/hello-java/tree/881cf366e10ba61162470936e267cab6930a2e57/spring/springboot-auth-example-202006">881cf366e10ba61162470936e267cab6930a2e57</a></p>
<p>んで前に触れたフィルタの適用順の話。
フィルタが適用される順番はもちろん重要で、例えば今回のフィルタを例にとると、 http://localhost:8080/login にアクセスしたとき、<code>JWTAuthorizationFilter</code>(Bearer トークンのデコード)より<code>JWTAuthenticationFilter</code>(Bearer トークンの生成)を優先してほしいわけですよ。
だってログインしようとしてるんだから Bearer トークン持ってるはずないじゃん。
なのに Bearer トークン要求されたらこれまた服を買いに行くための服以下略じゃないですか！</p>
<p>で、そのフィルタの順番なんですが、基本これ。</p>
<ul>
<li><a href="https://docs.spring.io/spring-security/site/docs/5.3.3.RELEASE/reference/html5/#ns-custom-filters">Table 2. Standard Filter Aliases and Ordering - 18.3.1. Adding in Your Own Filters</a></li>
</ul>
<p>この票に登場するクラス、それを継承したクラスは、<code>addFilter()</code>この表の順序に割り当てられる。
例えば<code>JWTAuthenticationFilter</code>は<code>UsernamePasswordAuthenticationFilter</code>を継承して作ってるので</p>
<pre><code>http.addFilter(new JWTAuthenticationFilter(manager));
</code></pre><p>とすると<code>UsernamePasswordAuthenticationFilter</code>のところに自動で割り当たる。</p>
<p>一方で、 <code>JWTAuthorizationFilter</code>はこの表に登場しない <code>OncePerRequestFilter</code> を継承して作っているので(※参考元コードとは異なります)、順序を明示的に教えてあげる必要がある。
なので、<code>JWTAuthenticationFilter</code>の後にしてくれ</p>
<pre><code>http.addFilterAfter(new JWTAuthorizationFilter(), JWTAuthenticationFilter.class);
</code></pre><p>ってやってるわけ。</p>
<h1 id="完成">完成</h1>
<p>んじゃ実行してみましょうよ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -X POST -d <span style="color:#e6db74">&#39;{
</span><span style="color:#e6db74">    &#34;username&#34;: &#34;ito&#34;,
</span><span style="color:#e6db74">    &#34;password&#34;: &#34;password&#34;
</span><span style="color:#e6db74">}&#39;</span> http://localhost:8080/users/sign-up
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -i -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -X POST -d <span style="color:#e6db74">&#39;{
</span><span style="color:#e6db74">    &#34;username&#34;: &#34;ito&#34;,
</span><span style="color:#e6db74">    &#34;password&#34;: &#34;password&#34;
</span><span style="color:#e6db74">}&#39;</span> http://localhost:8080/login
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -i -H <span style="color:#e6db74">&#34;Authorization: Bearer &lt;loginで取得したトークン文字列&gt;&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>http://localhost:8080/users
</code></pre></div><p>いかがでしたか？</p>

    </main>
</section>

<footer class="p-strip is-wrapper">
    <div class="row">
        <div class="p-article-pagination">
    
    <a class="p-article-pagination__link--previous" href="https://yukihane.github.io/posts/202006/13/list-contains-null/">
        <span class="p-article-pagination__label">Previous</span>
        <span class="p-article-pagination__title">
            List#contains(null)は使わないほうが良い
        </span>
    </a>
    

    
    <a class="p-article-pagination__link--next" href="https://yukihane.github.io/posts/202006/15/spring-boot-debugging/">
        <span class="p-article-pagination__label">Next</span>
        <span class="p-article-pagination__title">
            Spring BootのGradleでのデバッグ実行方法
        </span>
    </a>
    
</div>
    </div>
</footer>

        </div><footer class="p-strip is-shallow page-footer">
    <div class="row">
        <div class="col-12  u-align--center">
            <p>
                © 2020 発火後忘失
            </p>
        </div>
    </div>
</footer>




</body>
</html>
